{% extends 'base.html.twig' %}

{% block title %}Accueil - Liste des trajets{% endblock %}

{% block body %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="d-flex justify-content-between align-items-center mb-4" style="color:rgb(5, 28, 114);">
                <h1 class="h3 mb-0">
                    <i class="bi bi-car-front-fill me-2"></i> Trajets disponibles
                </h1>
                <div>
                    <a href="{{ path('app_reservation_index') }}" class="btn btn-sm btn-primary me-2">
                        <i class="bi bi-list-ul me-1"></i> Vos réservations
                    </a>
                    <a href="{{ path('app_vol_map')}}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-geo-alt me-1"></i> Voir Carte
                    </a>
                </div>
            </div>

            {# Barre de recherche avancée #}
            <div class="card mb-4 shadow-sm">
                <div class="card-body">
                    <form id="search-form" class="row g-3">
                        <!-- Départ -->
                        <div class="col-md-3">
                            <label for="departurePoint" class="form-label">Départ</label>
                            <div class="input-group">
                                <span class="input-group-text text-primary"><i class="bi bi-geo-alt-fill"></i></span>
                                <input type="text" class="form-control" id="departurePoint" name="departurePoint" 
                                       value="{{ searchCriteria.departurePoint }}" placeholder="Ville de départ">
                            </div>
                        </div>
                        
                        <!-- Destination -->
                        <div class="col-md-3">
                            <label for="destination" class="form-label">Destination</label>
                            <div class="input-group">
                                <span class="input-group-text text-primary"><i class="bi bi-geo-fill"></i></span>
                                <input type="text" class="form-control" id="destination" name="destination" 
                                       value="{{ searchCriteria.destination }}" placeholder="Ville d'arrivée">
                            </div>
                        </div>
                        
                        <!-- Date -->
                        <div class="col-md-3">
                            <label for="tripDate" class="form-label">Date</label>
                            <div class="input-group">
                                <span class="input-group-text text-primary"><i class="bi bi-calendar-date-fill"></i></span>
                                <input type="date" class="form-control" id="tripDate" name="tripDate" 
                                       value="{{ searchCriteria.tripDate }}">
                            </div>
                        </div>
                        
                        <!-- Tri et actions -->
                        <div class="col-md-3 d-flex flex-column justify-content-end">
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-outline-primary sort-btn flex-grow-1 {{ searchCriteria.order == 'ASC' ? 'active' : '' }}" 
                                        data-order="ASC">
                                    <i class="bi bi-sort-down-alt text-primary"></i> Anciens
                                </button>
                                <button type="button" class="btn btn-outline-primary sort-btn flex-grow-1 {{ searchCriteria.order == 'DESC' ? 'active' : '' }}" 
                                        data-order="DESC">
                                    <i class="bi bi-sort-up-alt text-primary"></i> Récents
                                </button>
                            </div>
                            <button type="submit" class="btn btn-primary mt-2 w-100">
                                <i class="bi bi-search text-white"></i> Rechercher
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Résultats -->
            <div id="trips-container">
                {% include 'trip/_trips_list.html.twig' with {'trips': trips} %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block stylesheets %}
{{ parent() }}
<style>
    .trip-card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .trip-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }
    
    .trip-header {
        background: linear-gradient(135deg, rgba(54, 95, 244, 0.1) 0%, rgba(13, 71, 161, 0.1) 100%);
        border-bottom: none;
        border-radius: 10px 10px 0 0 !important;
    }
    
    .sort-btn.active {
        background-color: rgba(54, 95, 244, 0.1);
        border-color: rgb(54, 95, 244);
        color: rgb(54, 95, 244);
    }
    
    #loading-indicator {
        display: none;
        text-align: center;
        padding: 20px;
    }
    
    /* Style pour les icônes bleues */
    .input-group-text.text-primary {
        background-color: rgba(13, 110, 253, 0.1);
    }
</style>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchForm = document.getElementById('search-form');
    const tripsContainer = document.getElementById('trips-container');
    const sortButtons = document.querySelectorAll('.sort-btn');
    
    // Current search state
    let currentSearch = {
        departurePoint: '{{ searchCriteria.departurePoint }}',
        destination: '{{ searchCriteria.destination }}',
        tripDate: '{{ searchCriteria.tripDate }}',
        order: '{{ searchCriteria.order }}'
    };
    
    // Load trips with AJAX
    function loadTrips() {
        // Show loading indicator
        tripsContainer.innerHTML = `
            <div id="loading-indicator">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Chargement...</span>
                </div>
                <p class="mt-2">Recherche des trajets...</p>
            </div>
        `;
        
        // Build query params
        const params = new URLSearchParams();
        if (currentSearch.departurePoint) params.append('departurePoint', currentSearch.departurePoint);
        if (currentSearch.destination) params.append('destination', currentSearch.destination);
        if (currentSearch.tripDate) params.append('tripDate', currentSearch.tripDate);
        params.append('order', currentSearch.order);
        
        // Make AJAX request
        fetch('{{ path('app_trip_home_client') }}?' + params.toString(), {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.text();
        })
        .then(html => {
            tripsContainer.innerHTML = html;
        })
        .catch(error => {
            console.error('Error:', error);
            tripsContainer.innerHTML = `
                <div class="alert alert-danger">
                    Une erreur est survenue lors du chargement des trajets. Veuillez réessayer.
                </div>
            `;
        });
    }
    
    // Form submission handler
    searchForm.addEventListener('submit', function(e) {
        e.preventDefault();
        currentSearch = {
            departurePoint: document.getElementById('departurePoint').value,
            destination: document.getElementById('destination').value,
            tripDate: document.getElementById('tripDate').value,
            order: currentSearch.order
        };
        loadTrips();
    });
    
    // Sort buttons handler
    sortButtons.forEach(button => {
        button.addEventListener('click', function() {
            sortButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            currentSearch.order = this.dataset.order;
            loadTrips();
        });
    });
    
    // Initial load if search parameters exist
    if (window.location.search.includes('departurePoint') || 
        window.location.search.includes('destination') || 
        window.location.search.includes('tripDate')) {
        loadTrips();
    }
});
</script>
{% endblock %}