<h1>ğŸ¡ Tournez la roue !</h1>

<canvas id="spinWheel" width="400" height="400"></canvas>
<br>
<button id="spinButton" onclick="spin()">ğŸ¯ Lancer la roue</button>
<p id="spinLimitMessage" style="color: red; font-weight: bold;"></p>
<audio id="spinSound" src="/sounds/spin-sound.mp3" preload="auto"></audio>
<audio id="rewardSound" src="/sounds/reward-sound.mp3" preload="auto"></audio>

<script>
let segments = [];
const userId = 2;
let spinning = false;
let selectedIndex = -1;
let currentAngle = 0;

// Fetch rewards
fetch('/recompense/spin/rewards')
    .then(response => response.json())
    .then(data => {
        segments = data;
        drawWheel();
    });

function drawWheel(angle = 0, highlightIndex = -1) {
    const canvas = document.getElementById('spinWheel');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, 400, 400);

    const total = segments.length;
    const arcSize = (2 * Math.PI) / total;

    for (let i = 0; i < total; i++) {
       const start = angle + arcSize * i - Math.PI / 2;
const end = angle + arcSize * (i + 1) - Math.PI / 2;



        ctx.beginPath();
        ctx.moveTo(200, 200);
        ctx.arc(200, 200, 200, start, end);

        if (i === highlightIndex) {
            ctx.fillStyle = 'rgba(255, 0, 0, 0.6)'; // Highlighted segment
        } else {
            ctx.fillStyle = `hsl(${(i * 360 / total)}, 70%, 70%)`;
        }

        ctx.fill();
        ctx.stroke();

        // Text
        const textAngle = start + arcSize / 2;
        ctx.fillStyle = '#000';
        ctx.font = '14px sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(segments[i], 200 + 120 * Math.cos(textAngle), 200 + 120 * Math.sin(textAngle));
    }

    // Arrow
    ctx.fillStyle = 'red';
    ctx.beginPath();
    ctx.moveTo(200, 0);
    ctx.lineTo(190, 20);
    ctx.lineTo(210, 20);
    ctx.fill();
}

function spin() {
    if (spinning || segments.length === 0) return alert("âš ï¸ Aucune rÃ©compense disponible !");
    spinning = true;
    selectedIndex = -1;

    const arcSize = (2 * Math.PI) / segments.length;
    const fullTurns = 5;
    const randomAngle = Math.random() * 2 * Math.PI;
    const finalAngle = fullTurns * 2 * Math.PI + randomAngle;

    const spinSound = document.getElementById('spinSound');
    const rewardSound = document.getElementById('rewardSound');
    spinSound.currentTime = 0;
    spinSound.play();

    const duration = 4000;
    const start = performance.now();

    function animate(now) {
        const elapsed = now - start;
        const progress = Math.min(elapsed / duration, 1);
        const easedProgress = easeOutCubic(progress);
        currentAngle = easedProgress * finalAngle;

        drawWheel(currentAngle);

        if (progress < 1) {
            requestAnimationFrame(animate);
        } else {
            spinSound.pause();

            const normalized = currentAngle % (2 * Math.PI);
const adjusted = (normalized - Math.PI / 2 + 2 * Math.PI) % (2 * Math.PI); // << fixed
selectedIndex = Math.floor(adjusted / arcSize) % segments.length;


            const selectedReward = segments[selectedIndex];
            drawWheel(currentAngle, selectedIndex); // Highlight

            rewardSound.play();

            fetch('/recompense/spin', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ userId: userId, reward: selectedReward })
})
.then(response => response.json())
.then(data => {
    if (data.error) {
        alert("âš ï¸ " + data.error);
    } else {
        alert("ğŸ‰ RÃ©compense attribuÃ©e : " + data.recompense);
        window.location.href = "/recompense/mon-profil";
    }
    spinning = false;
});


        }
    }

    requestAnimationFrame(animate);
}

function easeOutCubic(t) {
    return (--t) * t * t + 1;
}
</script>
